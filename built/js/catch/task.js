define(["zepto","api","template","catch/parabola","util"],function($,t,l,e,a){function o(){dollStage=$(".doll-stage"),dollFt=$(".doll-ft"),dollPowerBar=$(".doll-power-bar"),dollGift=dollPowerBar.find(".doll-gift"),trigger="click"}function n(){o(),s(),d()}var r=function(){var t=dollStage.data("task");t<5&&t++,dollStage.data("task",t),dollPowerBar.attr("class","doll-power-bar doll-power-"+t),t<5?dollGift.attr("class","doll-gift doll-gift-gray"):(dollGift.attr("class","doll-gift doll-gift-full pulse"),$(".doll-power-tips").html("点击礼包领取奖励哦"))},d=function(){$(".doll-stage").on(trigger,".doll-power",function(){var t=$(this);if("true"==t.attr("disabled"))return!1;t.attr("disabled",!0),dollStage.data("task")>=5&&i()})},s=function(){var l={},e=function(t){if(t.state){var l=t.data,e=1*l.num;return"number"==typeof e&&!isNaN(e)&&(e<5?dollGift.attr("class","doll-gift doll-gift-gray"):($(".doll-power-tips").html("点击礼包领取奖励哦"),dollGift.attr("class","doll-gift doll-gift-full pulse")),dollStage.data("task",e),void dollPowerBar.attr("class","doll-power-bar doll-power-"+e))}};t.checkTask(e,l)},i=function(){var e={},o=function(t){if($(".doll-power").removeAttr("disabled"),!t.state)return void a.ntips_center(t.msg);var e=t.data;if(0==e.remainCount)if($(".doll-power").removeAttr("disabled"),s(),0!=e.money){var o=e.money,n=$(".jsAdd"),r=n.find("b");r.html(o);var d=$(l("award_bonus_tpl",{bonus:o}));$("body").append(d);var i=$(".panel-bonus-beans"),f=i.offset(),c=i.width(),u=i.height(),g=f.left+c,p=f.top+u;$("#jsBeanImg").css({left:g+"px",top:p+"px"}),setTimeout(function(){$("#jsBeanImg").parent().css("background","none"),$("#jsBeanImg").fadeIn();var t=($(".doll-bean-total"),$(".jsbeanImg"),new Parabola({origin:".panel-bonus-beans",target:".jsBeanTarget",a:-.06,element:"#jsBeanImg",time:200,callback:function(t){n.removeClass("none"),d.fadeOut(),setTimeout(function(){$(".doll-power-tips").html('夹满<em class="yellow">5次</em>获随机奖励'),d.remove(),n.addClass("none"),a.getUserInfo(),s()},1200)}}));$("#jsBeanImg").addClass("fadeOut"),$(".jsBean01").addClass("beanScale"),t.move()},1e3)}else 0==e.money&&a.atips_center("fail","哎呀！运气实在太差，此次赚得欢乐豆数量为0！再接再厉哦！",function(){},function(){});else if(e.remainCount>0){$(".doll-power").removeAttr("disabled");var m="您还差"+e.remainCount+"次才能获得额外奖励";a.ntips_center(m),a.getUserInfo(),s()}},n=function(t){$(".doll-power").removeAttr("disabled"),a.ntips_center("网络错误")};t.getAward(o,e,n)};return{init:n,add:r,checkTask:s}});