define(["api","template","util"],function(t,e,l){function a(t){var e="",l="";switch(1*t){case 1:e="ka",l="bean";break;case 2:e="cy",l="gift";break;case 3:e="wx",l="phonecard";break;case 4:e="wx",l="paycard";break;case 5:e="wx",l="paycard"}return{emotion:e,branch:l}}var i=function(l){var a=function(t){if(t.state){var a=t.data;$("#jsdollbetbean").html(e("doll_bet_bean_tpl",a)),l()}};t.getRank(a)},n=function(){t.getGoodList(function(t){function i(){var t=$("#largeDollList"),e=parseFloat($(".doll-box").eq(0).css("width")),l=t.find("li"),a=(l.eq(0).width(),l.length/2),i=t.data("doll"),n=t.data("dolls");n||(n=[]);var r,s;if(i&&"hidden"==i.css("visibility")&&(n.push(i),t.removeData("doll"),i=null),parseFloat(t.css("left"))>=0){if(n&&n.length>0){for(var o=0;o<n.length;o++){var c=n[o],d=c.offset().left;if(d<e&&d>0){r=c.index(),s=r<a?r+a:a-r;var f=l.eq(s);f.css("visibility","hidden"),c.attr("style",""),n.splice(o,1,f)}}t.data("dolls",n)}}else{for(var h,p=0;p<n.length;p++)h=n[p],h.offset().left>=e&&(h.attr("style",""),n.splice(p,1),p--);t.data("dolls",n)}}if(!t.state&&-6==t.code)return void l.ntips_center("活动已暂停!");if(t.state){var n=t.data,r=l.store.get("gameType");void 0!=r&&null!=r||(r=0);var s=["low","middle","high"],o=s[r],c=n[o];if(!c||0==c.length)return $("#largeDollList").empty(),$("#smallDollList").empty(),!1;for(var d=[],f=[],h=0,p=c.length;h<p;h++){var u=c[h],v=a(u.ptype);u.emotion=v.emotion,u.branch=v.branch;var g=e("small_product_tpl",u),m=e("large_product_tpl",u);d.push(g),f.push(m)}var b=d.join(""),x=f.join(""),y=$(".doll-box-large"),w=$(".doll-box-small");$("#smallDollList").html(b),$("#largeDollList").html(x),clearInterval(y.attr("timer")),clearInterval(w.attr("timer")),y.eq(0).marquee({direct:"right",cb:i}),w.eq(0).marquee({direct:"left"})}},{},function(t){console.log(t)})},r=function(){t.getWins(function(t){if(!t.state)return!1;var l,a=t.data,i=$(".doll-notice"),n={record:a};a.length>0&&(l=e("wins_tpl",n)),i.find(".hidden-list").html(l),i.attr("data-index")||o({el:i,interval:1500})},{pageSize:10},function(t){console.log(t)})},s=function(){$.fn.marquee=function(t){var e={speed:20,direct:"right",cb:function(){}};return t=$.extend(e,t),this.each(function(){function e(){"right"==t.direct?(t.cb&&t.cb(),parseFloat(a.css("left"))>=0?c.style.left=-a.width()/2+"px":c.style.left=parseFloat(a.css("left"))+1+"px"):"left"==t.direct&&(t.cb&&t.cb(),parseFloat(a.css("left"))<=parseFloat(-a.width()/2)?c.style.left="0px":c.style.left=parseFloat(a.css("left"))-1+"px")}var l=$(this),a=l.find("ul");if(a.find("li").length<3)return void a.attr("style","");var i=a.html();a.append(i);var n=a.find("li"),r=parseFloat(n.eq(0).css("margin-left")),s=parseFloat(n.eq(0).css("width")),o=(s+r)*n.length;a.css("width",o+"px");var c=a.get(0);"right"==t.direct&&(c.style.left=-a.width()/2+"px");var d=setInterval(e,t.speed);l.attr("timer",d)})}},o=function(t){var e=t.el,l=e.find(".notice-list"),a=e.find(".hidden-list"),i=a.find("li");f=null,l.html(i.first().clone()),i.length<=1||(f&&clearInterval(f),f=setInterval(function(){i=a.find("li");var n=((1*e.attr("data-index")||0)+1)%i.length,r=i.eq(n),s=r.clone();l.append(s);var o=l.children().first(),c=0-o.height();l.animate({marginTop:c+"px"},t.time||500,function(){o.remove(),l.css("marginTop","0px"),e.attr("data-index",n)})},t.interval||1500))};return{getRank:i,rollProducts:n,rollWins:r,init:function(){s(),r(),setInterval(function(){r()},6e4)}}});